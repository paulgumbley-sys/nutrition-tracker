<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .date-display {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .view-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        
        .view-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
        }
        
        .date-range {
            font-size: 0.95em;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .card .unit {
            font-size: 0.8em;
            color: #666;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .search-section {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-header h3 {
            color: #2e7d32;
            font-size: 1.2em;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #4caf50;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        .search-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .search-btn:hover {
            background: #45a049;
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .result-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background: #f0f0f0;
        }
        
        .result-info {
            flex: 1;
        }
        
        .result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 1.05em;
        }
        
        .result-brand {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .result-nutrition {
            font-size: 0.8em;
            color: #999;
            display: flex;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .info-message {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }
        
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .food-log {
            margin-top: 30px;
        }
        
        .food-log h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .day-section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .day-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .day-totals {
            font-size: 0.85em;
            color: #666;
            display: flex;
            gap: 15px;
        }
        
        .food-item {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .food-item:hover {
            background: #f8f9fa;
        }
        
        .food-item:last-child {
            border-bottom: none;
        }
        
        .food-details {
            flex: 1;
        }
        
        .food-name {
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 5px;
            color: #333;
        }
        
        .food-serving {
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .food-macros {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.85em;
            color: #666;
        }
        
        .macro-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            width: auto;
        }
        
        .delete-btn:hover {
            background: #c82333;
            transform: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            width: auto;
        }
        
        .tab:hover {
            color: #667eea;
            transform: none;
            box-shadow: none;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .database-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .serving-input-group {
            margin-bottom: 15px;
        }
        
        .serving-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .serving-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .serving-examples {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-btn-secondary {
            background: #e0e0e0;
            color: #666;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•ó Nutrition Tracker</h1>
            <div class="date-display" id="dateDisplay"></div>
        </header>
        
        <div class="content">
            <div class="view-controls">
                <button class="view-btn active" onclick="changeView('today')">Today</button>
                <button class="view-btn" onclick="changeView('week')">This Week</button>
                <button class="view-btn" onclick="changeView('all')">All Days</button>
            </div>
            
            <div class="date-range" id="dateRange"></div>
            
            <div class="summary-cards">
                <div class="card">
                    <h3>Calories</h3>
                    <div class="value" id="totalCalories">0</div>
                    <div class="unit">kcal</div>
                </div>
                <div class="card">
                    <h3>Protein</h3>
                    <div class="value" id="totalProtein">0</div>
                    <div class="unit">g</div>
                </div>
                <div class="card">
                    <h3>Carbs</h3>
                    <div class="value" id="totalCarbs">0</div>
                    <div class="unit">g</div>
                </div>
                <div class="card">
                    <h3>Fat</h3>
                    <div class="value" id="totalFat">0</div>
                    <div class="unit">g</div>
                </div>
                <div class="card">
                    <h3>Sugar</h3>
                    <div class="value" id="totalSugar">0</div>
                    <div class="unit">g</div>
                </div>
                <div class="card">
                    <h3>Fiber</h3>
                    <div class="value" id="totalFiber">0</div>
                    <div class="unit">g</div>
                </div>
                <div class="card">
                    <h3>Unsat. Fat</h3>
                    <div class="value" id="totalUnsatFat">0</div>
                    <div class="unit">g</div>
                </div>
            </div>
            
            <div class="input-section">
                <h2>Add Food Item</h2>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('search')">üîç Search Database <span class="database-badge">Open Food Facts</span></button>
                    <button class="tab" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</button>
                </div>
                
                <div id="searchTab" class="tab-content active">
                    <div class="search-section">
                        <div class="search-header">
                            <h3>Search UK & European Foods</h3>
                        </div>
                        <div class="info-message" style="margin-bottom: 15px;">
                            üá¨üáß Powered by Open Food Facts - Search UK supermarket products, brands, and generic foods
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Search foods (e.g., 'tesco chicken', 'banana', 'sainsburys bread')..." onkeypress="handleSearchEnter(event)">
                            <button class="search-btn" onclick="searchFoods()" id="searchButton">Search</button>
                        </div>
                        <div id="searchResults"></div>
                    </div>
                </div>
                
                <div id="manualTab" class="tab-content">
                    <form id="foodForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="foodName">Food Name *</label>
                                <input type="text" id="foodName" required>
                            </div>
                            <div class="form-group">
                                <label for="servingSize">Serving Size (e.g., 0.5, 2) *</label>
                                <input type="number" id="servingSize" step="0.01" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="calories">Calories (kcal per serving) *</label>
                                <input type="number" id="calories" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="protein">Protein (g per serving) *</label>
                                <input type="number" id="protein" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="carbs">Carbs (g per serving) *</label>
                                <input type="number" id="carbs" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="fat">Total Fat (g per serving) *</label>
                                <input type="number" id="fat" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="sugar">Sugar (g per serving)</label>
                                <input type="number" id="sugar" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="fiber">Fiber (g per serving)</label>
                                <input type="number" id="fiber" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="unsatFat">Unsaturated Fat (g per serving)</label>
                                <input type="number" id="unsatFat" step="0.1" value="0">
                            </div>
                        </div>
                        <button type="submit">Add to Log</button>
                    </form>
                </div>
            </div>
            
            <div class="food-log">
                <h2 id="logTitle">Today's Food Log</h2>
                <div id="foodList">
                    <div class="empty-state">
                        No foods logged yet. Add your first meal above!
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Serving Size Modal -->
    <div id="servingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">How much did you eat?</div>
            <div class="modal-body">
                <div class="serving-input-group">
                    <label for="servingAmount">Serving Amount</label>
                    <input type="number" id="servingAmount" step="0.01" value="1" min="0.01">
                    <div class="serving-examples">Examples: 1 (full serving), 0.5 (half), 2 (double)</div>
                </div>
                <div id="servingPreview" style="margin-top: 15px; padding: 12px; background: #f5f7fa; border-radius: 8px; font-size: 0.9em;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeServingModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmServing()">Add to Log</button>
            </div>
        </div>
    </div>
    
    <script>
        let foodLog = [];
        let currentView = 'today';
        let pendingFood = null;
        
        // Load food log from localStorage
        function loadFoodLog() {
            const saved = localStorage.getItem('nutrition_tracker_log');
            if (saved) {
                foodLog = JSON.parse(saved);
            }
        }
        
        // Save food log to localStorage
        function saveFoodLog() {
            localStorage.setItem('nutrition_tracker_log', JSON.stringify(foodLog));
        }
        
        // Display current date
        const dateDisplay = document.getElementById('dateDisplay');
        const today = new Date();
        dateDisplay.textContent = today.toLocaleDateString('en-GB', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            if (targetDate.getTime() === today.getTime()) {
                return 'Today';
            } else if (targetDate.getTime() === yesterday.getTime()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric',
                    month: 'long'
                });
            }
        }
        
        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDateRange();
            updateDisplay();
        }
        
        function updateDateRange() {
            const dateRange = document.getElementById('dateRange');
            const logTitle = document.getElementById('logTitle');
            
            if (currentView === 'today') {
                dateRange.textContent = '';
                logTitle.textContent = "Today's Food Log";
            } else if (currentView === 'week') {
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(today);
                
                dateRange.textContent = `${weekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                logTitle.textContent = "This Week's Food Log";
            } else {
                dateRange.textContent = 'All recorded days';
                logTitle.textContent = "All Food Logs";
            }
        }
        
        function getFilteredDates() {
            const today = new Date();
            const todayStr = getDateString(today);
            
            if (currentView === 'today') {
                return [todayStr];
            } else if (currentView === 'week') {
                const dates = [];
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                
                for (let i = 0; i <= today.getDay(); i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    dates.push(getDateString(date));
                }
                return dates;
            } else {
                // Get all unique dates from food log
                const uniqueDates = [...new Set(foodLog.map(food => food.date))];
                return uniqueDates.sort().reverse();
            }
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'search') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('searchTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('manualTab').classList.add('active');
            }
        }
        
        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                searchFoods();
            }
        }
        
        async function searchFoods() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            const searchButton = document.getElementById('searchButton');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="info-message">Please enter a food name to search</div>';
                return;
            }
            
            searchButton.disabled = true;
            resultsDiv.innerHTML = '<div class="loading">üîç Searching Open Food Facts database</div>';
            
            try {
                const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,image_url,nutriments,serving_size,code`);
                
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                
                const data = await response.json();
                
                if (!data.products || data.products.length === 0) {
                    resultsDiv.innerHTML = '<div class="info-message">No foods found. Try a different search term or brand name (e.g., "tesco", "sainsburys")</div>';
                    return;
                }
                
                const validProducts = data.products.filter(p => 
                    p.nutriments && (p.nutriments.energy_100g || p.nutriments['energy-kcal_100g'])
                );
                
                if (validProducts.length === 0) {
                    resultsDiv.innerHTML = '<div class="info-message">No foods with nutrition data found. Try another search.</div>';
                    return;
                }
                
                resultsDiv.innerHTML = validProducts.slice(0, 10).map(product => {
                    const nutrients = product.nutriments;
                    const calories = nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184);
                    const protein = nutrients.proteins_100g || 0;
                    const carbs = nutrients.carbohydrates_100g || 0;
                    const fat = nutrients.fat_100g || 0;
                    
                    return `
                        <div class="search-result-item" onclick='showServingModal(${JSON.stringify({
                            name: product.product_name || 'Unknown Product',
                            brand: product.brands || '',
                            image: product.image_url || '',
                            code: product.code,
                            nutrients: nutrients
                        })})'>
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.product_name}" class="result-image">` : '<div class="result-image"></div>'}
                            <div class="result-info">
                                <div class="result-name">${product.product_name || 'Unknown Product'}</div>
                                ${product.brands ? `<div class="result-brand">${product.brands}</div>` : ''}
                                <div class="result-nutrition">
                                    <span>üìä ${calories} kcal</span>
                                    <span>ü•© P: ${protein.toFixed(1)}g</span>
                                    <span>üåæ C: ${carbs.toFixed(1)}g</span>
                                    <span>ü•ë F: ${fat.toFixed(1)}g</span>
                                    <span style="color: #999;">(per 100g)</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}. Please check your internet connection and try again.</div>`;
            } finally {
                searchButton.disabled = false;
            }
        }
        
        function showServingModal(productData) {
            pendingFood = productData;
            document.getElementById('servingAmount').value = '1';
            updateServingPreview();
            document.getElementById('servingModal').style.display = 'block';
        }
        
        function closeServingModal() {
            document.getElementById('servingModal').style.display = 'none';
            pendingFood = null;
        }
        
        function updateServingPreview() {
            const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
            if (!pendingFood) return;
            
            const nutrients = pendingFood.nutrients;
            const calories = (nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184)) * amount;
            const protein = (nutrients.proteins_100g || 0) * amount;
            const carbs = (nutrients.carbohydrates_100g || 0) * amount;
            const fat = (nutrients.fat_100g || 0) * amount;
            
            document.getElementById('servingPreview').innerHTML = `
                <strong>${pendingFood.name}</strong><br>
                <span style="color: #667eea; font-weight: 600;">${amount} √ó 100g serving</span><br>
                <div style="margin-top: 8px; color: #666;">
                    ${Math.round(calories)} kcal | 
                    P: ${protein.toFixed(1)}g | 
                    C: ${carbs.toFixed(1)}g | 
                    F: ${fat.toFixed(1)}g
                </div>
            `;
        }
        
        document.getElementById('servingAmount').addEventListener('input', updateServingPreview);
        
        function confirmServing() {
            if (!pendingFood) return;
            
            const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
            const nutrients = pendingFood.nutrients;
            
            const calories = (nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184)) * amount;
            const protein = (nutrients.proteins_100g || 0) * amount;
            const carbs = (nutrients.carbohydrates_100g || 0) * amount;
            const fat = (nutrients.fat_100g || 0) * amount;
            const sugar = (nutrients.sugars_100g || 0) * amount;
            const fiber = (nutrients.fiber_100g || 0) * amount;
            const saturatedFat = (nutrients['saturated-fat_100g'] || 0) * amount;
            const unsatFat = Math.max(0, fat - saturatedFat);
            
            const foodName = `${pendingFood.name}${pendingFood.brand ? ' - ' + pendingFood.brand : ''}`;
            
            const food = {
                id: Date.now(),
                date: getDateString(new Date()),
                name: foodName,
                servingSize: amount,
                servingUnit: '100g',
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                sugar: sugar,
                fiber: fiber,
                unsatFat: unsatFat
            };
            
            foodLog.push(food);
            saveFoodLog();
            updateDisplay();
            
            closeServingModal();
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<div class="success-message">‚úÖ Added ${amount}√ó "${pendingFood.name}" to your food log!</div>`;
            document.getElementById('searchInput').value = '';
            
            setTimeout(() => {
                resultsDiv.innerHTML = '';
            }, 3000);
        }
        
        document.getElementById('foodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const servingSize = parseFloat(document.getElementById('servingSize').value) || 1;
            
            const food = {
                id: Date.now(),
                date: getDateString(new Date()),
                name: document.getElementById('foodName').value,
                servingSize: servingSize,
                servingUnit: 'serving',
                calories: parseFloat(document.getElementById('calories').value) || 0,
                protein: parseFloat(document.getElementById('protein').value) || 0,
                carbs: parseFloat(document.getElementById('carbs').value) || 0,
                fat: parseFloat(document.getElementById('fat').value) || 0,
                sugar: parseFloat(document.getElementById('sugar').value) || 0,
                fiber: parseFloat(document.getElementById('fiber').value) || 0,
                unsatFat: parseFloat(document.getElementById('unsatFat').value) || 0
            };
            
            foodLog.push(food);
            saveFoodLog();
            updateDisplay();
            this.reset();
            document.getElementById('servingSize').value = '1';
        });
        
        function updateDisplay() {
            const dates = getFilteredDates();
            
            // Calculate totals for the selected view
            const filteredLog = foodLog.filter(food => dates.includes(food.date));
            
            const totals = filteredLog.reduce((acc, food) => {
                acc.calories += food.calories;
                acc.protein += food.protein;
                acc.carbs += food.carbs;
                acc.fat += food.fat;
                acc.sugar += food.sugar;
                acc.fiber += food.fiber;
                acc.unsatFat += food.unsatFat;
                return acc;
            }, {
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                sugar: 0,
                fiber: 0,
                unsatFat: 0
            });
            
            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = totals.protein.toFixed(1);
            document.getElementById('totalCarbs').textContent = totals.carbs.toFixed(1);
            document.getElementById('totalFat').textContent = totals.fat.toFixed(1);
            document.getElementById('totalSugar').textContent = totals.sugar.toFixed(1);
            document.getElementById('totalFiber').textContent = totals.fiber.toFixed(1);
            document.getElementById('totalUnsatFat').textContent = totals.unsatFat.toFixed(1);
            
            // Update food list grouped by date
            const foodList = document.getElementById('foodList');
            if (filteredLog.length === 0) {
                foodList.innerHTML = '<div class="empty-state">No foods logged for this period. Add your first meal above!</div>';
            } else {
                // Group foods by date
                const foodsByDate = {};
                dates.forEach(date => {
                    foodsByDate[date] = foodLog.filter(food => food.date === date);
                });
                
                foodList.innerHTML = dates.map(date => {
                    const dayFoods = foodsByDate[date];
                    if (dayFoods.length === 0) return '';
                    
                    const dayTotals = dayFoods.reduce((acc, food) => {
                        acc.calories += food.calories;
                        return acc;
                    }, { calories: 0 });
                    
                    return `
                        <div class="day-section">
                            <div class="day-header">
                                <span>${formatDateForDisplay(date)}</span>
                                <span class="day-totals">${Math.round(dayTotals.calories)} kcal</span>
                            </div>
                            ${dayFoods.map(food => `
                                <div class="food-item">
                                    <div class="food-details">
                                        <div class="food-name">${food.name}</div>
                                        <div class="food-serving">${food.servingSize}√ó ${food.servingUnit}</div>
                                        <div class="food-macros">
                                            <span class="macro-item">üìä ${Math.round(food.calories)} kcal</span>
                                            <span class="macro-item">ü•© P: ${food.protein.toFixed(1)}g</span>
                                            <span class="macro-item">üåæ C: ${food.carbs.toFixed(1)}g</span>
                                            <span class="macro-item">ü•ë F: ${food.fat.toFixed(1)}g</span>
                                            ${food.sugar > 0 ? `<span class="macro-item">üç¨ Sugar: ${food.sugar.toFixed(1)}g</span>` : ''}
                                            ${food.fiber > 0 ? `<span class="macro-item">üåø Fiber: ${food.fiber.toFixed(1)}g</span>` : ''}
                                            ${food.unsatFat > 0 ? `<span class="macro-item">ü´í Unsat: ${food.unsatFat.toFixed(1)}g</span>` : ''}
                                        </div>
                                    </div>
                                    <button class="delete-btn" onclick="deleteFood(${food.id})">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            }
        }
        
        function deleteFood(id) {
            foodLog = foodLog.filter(food => food.id !== id);
            saveFoodLog();
            updateDisplay();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('servingModal');
            if (event.target === modal) {
                closeServingModal();
            }
        }
        
        // Initial load
        loadFoodLog();
        updateDateRange();
        updateDisplay();
    </script>
</body>
</html>

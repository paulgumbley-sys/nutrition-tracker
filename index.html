<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .date-display {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .view-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        
        .view-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
        }
        
        .settings-btn {
            background: #ff9800;
            color: white;
            border: 2px solid #ff9800;
        }
        
        .settings-btn:hover {
            background: #f57c00;
        }
        
        .date-range {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }
        
        /* MyFitnessPal Style Summary */
        .summary-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .summary-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .toggle-btn {
            background: white;
            border: 2px solid #dee2e6;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }
        
        .summary-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .summary-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }
        
        .summary-goal {
            font-size: 0.75em;
            color: #999;
        }
        
        .summary-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        
        .summary-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .summary-bar-fill.over-goal {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .input-section h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        
        .quick-action-btn:hover {
            background: #667eea;
            color: white;
            transform: none;
            box-shadow: none;
        }
        
        .search-section {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .search-header h3 {
            color: #2e7d32;
            font-size: 1.1em;
        }
        
        .meal-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .meal-btn {
            background: white;
            color: #2e7d32;
            border: 2px solid #4caf50;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 70px;
        }
        
        @media (max-width: 600px) {
            .meal-selector {
                width: 100%;
            }
            
            .meal-btn {
                flex: 1 1 calc(50% - 6px);
                font-size: 0.7em;
                padding: 6px 8px;
            }
            
            .search-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-header h3 {
                text-align: center;
            }
        }
        
        .meal-btn.active {
            background: #4caf50;
            color: white;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px;
            border: 2px solid #4caf50;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        .search-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .search-btn:hover {
            background: #45a049;
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .search-results {
            max-height: 350px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .result-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            background: #f0f0f0;
        }
        
        .result-info {
            flex: 1;
        }
        
        .result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
            font-size: 0.95em;
        }
        
        .result-brand {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 3px;
        }
        
        .result-nutrition {
            font-size: 0.75em;
            color: #999;
            display: flex;
            gap: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 25px;
            color: #666;
            font-size: 0.9em;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error-message, .info-message, .success-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
        }
        
        .info-message {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 0.85em;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .food-log {
            margin-top: 25px;
        }
        
        .food-log h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }
        
        .day-section {
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .day-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 12px 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        
        .day-totals {
            font-size: 0.85em;
            color: #666;
            display: flex;
            gap: 12px;
        }
        
        .meal-section {
            border-bottom: 1px solid #e9ecef;
        }
        
        .meal-section:last-child {
            border-bottom: none;
        }
        
        .meal-header {
            background: #f8f9fa;
            padding: 10px 18px;
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .meal-totals {
            font-size: 0.8em;
            color: #999;
        }
        
        .food-item {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .food-item:hover {
            background: #f8f9fa;
        }
        
        .food-item:last-child {
            border-bottom: none;
        }
        
        .food-details {
            flex: 1;
        }
        
        .food-name {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 4px;
            color: #333;
        }
        
        .food-serving {
            font-size: 0.8em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .food-time {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 4px;
        }
        
        .food-macros {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.8em;
            color: #666;
        }
        
        .macro-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
            width: auto;
            margin-left: 5px;
        }
        
        .delete-btn:hover {
            background: #c82333;
            transform: none;
        }
        
        .edit-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
            width: auto;
        }
        
        .edit-btn:hover {
            background: #f57c00;
            transform: none;
        }
        
        .food-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .date-picker-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .date-picker-section label {
            font-weight: 600;
            color: #1565c0;
        }
        
        .date-picker-section input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .date-picker-section button {
            padding: 8px 16px;
            width: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 35px;
            color: #999;
            font-size: 0.9em;
        }
        
        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            width: auto;
        }
        
        .tab:hover {
            color: #667eea;
            transform: none;
            box-shadow: none;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .database-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 18px;
        }
        
        .modal-body {
            margin-bottom: 18px;
        }
        
        .serving-input-group {
            margin-bottom: 12px;
        }
        
        .serving-input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }
        
        .serving-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
        }
        
        .serving-examples {
            font-size: 0.8em;
            color: #999;
            margin-top: 4px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-btn-secondary {
            background: #e0e0e0;
            color: #666;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .saved-meal-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .saved-meal-item:hover {
            background: #e3f2fd;
            border-color: #667eea;
        }
        
        .saved-meal-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .saved-meal-info {
            font-size: 0.8em;
            color: #666;
        }
        
        .checkbox-group {
            margin: 10px 0;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .recent-items-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .recent-items-header {
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .recent-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .recent-item:last-child {
            border-bottom: none;
        }
        
        .recent-item:hover {
            background: #f8f9fa;
        }
        
        .recent-item-info {
            flex: 1;
        }
        
        .recent-item-name {
            font-weight: 600;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 2px;
        }
        
        .recent-item-details {
            font-size: 0.75em;
            color: #999;
        }
        
        .recent-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .recent-item-actions .edit-btn,
        .recent-item-actions .delete-btn {
            padding: 4px 10px;
            font-size: 0.75em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü•ó Nutrition Tracker</h1>
            <div class="date-display" id="dateDisplay"></div>
        </header>
        
        <div class="content">
            <div class="view-controls">
                <button class="view-btn active" onclick="changeView('today')">Today</button>
                <button class="view-btn" onclick="changeView('week')">This Week</button>
                <button class="view-btn" onclick="changeView('all')">All Days</button>
                <button class="view-btn settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Goals</button>
            </div>
            
            <div class="date-range" id="dateRange"></div>
            
            <!-- MyFitnessPal Style Summary -->
            <div class="summary-container">
                <div class="summary-toggle">
                    <button class="toggle-btn active" onclick="toggleSummaryView('totals')">Totals</button>
                    <button class="toggle-btn" onclick="toggleSummaryView('percent')">% of Goal</button>
                </div>
                
                <div class="summary-grid" id="summaryGrid">
                    <!-- Dynamic content -->
                </div>
                
                <div id="recentItemsContainer">
                    <!-- Recent items will appear here for today view -->
                </div>
            </div>
            
            <div class="input-section">
                <h2>Add Food Item</h2>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="openSavedMealsModal()">üìÅ Saved Meals</button>
                    <button class="quick-action-btn" id="repeatBreakfastBtn" onclick="repeatYesterdayBreakfast()" style="display: none;">üîÑ Repeat Yesterday's Breakfast</button>
                </div>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('search')">üîç Search <span class="database-badge">Open Food Facts</span></button>
                    <button class="tab" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</button>
                </div>
                
                <div id="searchTab" class="tab-content active">
                    <div class="search-section">
                        <div class="search-header">
                            <h3>Search UK & European Foods</h3>
                            <div class="meal-selector">
                                <button class="meal-btn active" data-meal="breakfast" onclick="selectMeal('breakfast')">Breakfast</button>
                                <button class="meal-btn" data-meal="lunch" onclick="selectMeal('lunch')">Lunch</button>
                                <button class="meal-btn" data-meal="dinner" onclick="selectMeal('dinner')">Dinner</button>
                                <button class="meal-btn" data-meal="snacks" onclick="selectMeal('snacks')">Snacks</button>
                            </div>
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Search foods..." onkeypress="handleSearchEnter(event)">
                            <button class="search-btn" onclick="searchFoods()" id="searchButton">Search</button>
                        </div>
                        <div id="searchResults"></div>
                    </div>
                </div>
                
                <div id="manualTab" class="tab-content">
                    <form id="foodForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="mealType">Meal Type *</label>
                                <select id="mealType" required>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="snacks">Snacks</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="foodTime">Time *</label>
                                <input type="time" id="foodTime" required step="300">
                            </div>
                            <div class="form-group">
                                <label for="foodName">Food Name *</label>
                                <input type="text" id="foodName" required>
                            </div>
                            <div class="form-group">
                                <label for="servingSize">Serving Size *</label>
                                <input type="number" id="servingSize" step="0.01" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="calories">Calories (kcal) *</label>
                                <input type="number" id="calories" step="0.1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="protein">Protein (g) *</label>
                                <input type="number" id="protein" step="0.1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="carbs">Carbs (g) *</label>
                                <input type="number" id="carbs" step="0.1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="fat">Total Fat (g) *</label>
                                <input type="number" id="fat" step="0.1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="sugar">Sugar (g)</label>
                                <input type="number" id="sugar" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="fiber">Fiber (g)</label>
                                <input type="number" id="fiber" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="satFat">Saturated Fat (g)</label>
                                <input type="number" id="satFat" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="salt">Salt (mg)</label>
                                <input type="number" id="salt" step="1" value="0">
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="saveAsMeal">
                                Save this as a meal for later
                            </label>
                        </div>
                        <button type="submit">Add to Log</button>
                    </form>
                </div>
            </div>
            
            <div class="food-log">
                <h2 id="logTitle">Today's Food Log</h2>
                <div class="date-picker-section" id="datePicker" style="display: none;">
                    <label for="viewDate">View Date:</label>
                    <input type="date" id="viewDate">
                    <button onclick="viewSelectedDate()">View</button>
                    <button onclick="viewToday()" style="background: #4caf50;">Today</button>
                </div>
                <div id="foodList">
                    <div class="empty-state">
                        No foods logged yet. Add your first meal above!
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Serving Size Modal -->
    <div id="servingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">How much did you eat?</div>
            <div class="modal-body">
                <div class="serving-input-group">
                    <label for="servingAmount">Serving Amount</label>
                    <input type="number" id="servingAmount" step="0.01" value="1" min="0.01">
                    <div class="serving-examples">Examples: 1 (full), 0.5 (half), 2 (double)</div>
                </div>
                <div class="serving-input-group">
                    <label for="servingTime">Time</label>
                    <input type="time" id="servingTime" step="300">
                </div>
                <div id="servingPreview" style="margin-top: 12px; padding: 10px; background: #f5f7fa; border-radius: 8px; font-size: 0.85em;">
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="saveServingAsMeal">
                        Save this as a meal
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeServingModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmServing()">Add to Log</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Daily Nutrition Goals</div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="goalCalories">Calories (kcal)</label>
                        <input type="number" id="goalCalories" step="1" value="2000">
                    </div>
                    <div class="form-group">
                        <label for="goalProtein">Protein (g)</label>
                        <input type="number" id="goalProtein" step="1" value="150">
                    </div>
                    <div class="form-group">
                        <label for="goalCarbs">Carbs (g)</label>
                        <input type="number" id="goalCarbs" step="1" value="200">
                    </div>
                    <div class="form-group">
                        <label for="goalFat">Fat (g)</label>
                        <input type="number" id="goalFat" step="1" value="65">
                    </div>
                    <div class="form-group">
                        <label for="goalSugar">Sugar (g)</label>
                        <input type="number" id="goalSugar" step="1" value="50">
                    </div>
                    <div class="form-group">
                        <label for="goalFiber">Fiber (g)</label>
                        <input type="number" id="goalFiber" step="1" value="30">
                    </div>
                    <div class="form-group">
                        <label for="goalSatFat">Saturated Fat (g)</label>
                        <input type="number" id="goalSatFat" step="1" value="20">
                    </div>
                    <div class="form-group">
                        <label for="goalSalt">Salt (mg)</label>
                        <input type="number" id="goalSalt" step="1" value="6000">
                    </div>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.1em; color: #333;">‚òÅÔ∏è Automatic Cloud Sync</h3>
                    <div id="cloudSyncStatus" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; border: 2px solid #ffc107;">
                        <strong>‚ö†Ô∏è Cloud Sync Not Connected</strong><br><br>
                        Click "Connect Cloud Sync" below to enable automatic syncing across all your devices.
                    </div>
                    <button class="modal-btn modal-btn-primary" id="cloudSyncBtn" style="width: 100%; background: #4caf50; margin-bottom: 10px;" onclick="setupCloudSync()">‚òÅÔ∏è Connect Cloud Sync</button>
                    <button class="modal-btn modal-btn-secondary" id="disconnectSyncBtn" style="width: 100%; display: none;" onclick="disconnectCloudSync()">üîå Disconnect Cloud Sync</button>
                    <div style="font-size: 0.85em; color: #666; margin-top: 10px;">
                        <strong>Note:</strong> Automatic sync works best within the same browser (e.g., Chrome on multiple devices signed into Google).<br>
                        For phone ‚Üî PC sync, use Manual Sync below.
                    </div>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.1em; color: #333;">üîÑ Manual Device Sync</h3>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                        <strong>Sync between Phone and PC:</strong><br><br>
                        <strong>On Phone:</strong> Click "Export Sync Code" ‚Üí Copy code<br>
                        <strong>On PC:</strong> Click "Import Sync Code" ‚Üí Paste code<br><br>
                        <em>Data merges safely - nothing gets deleted!</em>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="modal-btn modal-btn-primary" style="flex: 1; background: #2196F3;" onclick="exportManualSyncCode()">üì§ Export Sync Code</button>
                        <button class="modal-btn modal-btn-primary" style="flex: 1; background: #4caf50;" onclick="importManualSyncCode()">üì• Import Sync Code</button>
                    </div>
                    <textarea id="manualSyncCodeArea" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.7em; resize: vertical;" placeholder="Sync code appears here..."></textarea>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.1em; color: #333;">üìä Export Data to Excel</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportStartDate">Start Date</label>
                            <input type="date" id="exportStartDate">
                        </div>
                        <div class="form-group">
                            <label for="exportEndDate">End Date</label>
                            <input type="date" id="exportEndDate">
                        </div>
                    </div>
                    <button class="modal-btn modal-btn-primary" style="margin-top: 10px; background: #4caf50; width: 100%;" onclick="exportToExcel()">Download Excel Report</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveGoals()">Save Goals</button>
            </div>
        </div>
    </div>
    
    <!-- Saved Meals Modal -->
    <div id="savedMealsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Saved Meals</div>
            <div class="modal-body" id="savedMealsList">
                <!-- Dynamic content -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeSavedMealsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Food Modal -->
    <div id="editFoodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Food Entry</div>
            <div class="modal-body">
                <div class="serving-input-group">
                    <label for="editServingSize">Serving Size</label>
                    <input type="number" id="editServingSize" step="0.01" min="0.01">
                </div>
                <div class="serving-input-group">
                    <label for="editTime">Time</label>
                    <input type="time" id="editTime" step="300">
                </div>
                <div id="editPreview" style="margin-top: 12px; padding: 10px; background: #f5f7fa; border-radius: 8px; font-size: 0.85em;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        let foodLog = [];
        let savedMeals = [];
        let goals = {
            calories: 2000,
            protein: 150,
            carbs: 200,
            fat: 65,
            sugar: 50,
            fiber: 30,
            satFat: 20,
            salt: 6000
        };
        let currentView = 'today';
        let summaryView = 'totals';
        let pendingFood = null;
        let pendingPersonalFood = null; // For personal foods
        let currentMeal = 'breakfast';
        let currentViewDate = null; // For single day view
        let editingFoodId = null; // For editing
        
        // Load data from localStorage
        function loadData() {
            const savedLog = localStorage.getItem('nutrition_tracker_log');
            const savedGoals = localStorage.getItem('nutrition_tracker_goals');
            const savedMealsData = localStorage.getItem('nutrition_tracker_saved_meals');
            
            if (savedLog) foodLog = JSON.parse(savedLog);
            if (savedGoals) goals = JSON.parse(savedGoals);
            if (savedMealsData) savedMeals = JSON.parse(savedMealsData);
            
            // DATA MIGRATION: Fix old entries that have unsatFat instead of satFat
            let migrated = false;
            foodLog = foodLog.map(food => {
                // If old entry has unsatFat, convert it (but note: we changed from unsat to sat, so recalculate)
                if (food.unsatFat !== undefined && food.satFat === undefined) {
                    migrated = true;
                    // Old: unsatFat = total - saturated (we stored unsaturated)
                    // New: satFat = saturated fat directly
                    // Estimate: if we had total fat, assume 30% is saturated
                    const estimatedSatFat = food.fat ? food.fat * 0.3 : 0;
                    return {
                        ...food,
                        satFat: Number(estimatedSatFat) || 0,
                        unsatFat: undefined // Remove old field
                    };
                }
                // Ensure satFat exists (add if missing)
                if (food.satFat === undefined) {
                    migrated = true;
                    const estimatedSatFat = food.fat ? food.fat * 0.3 : 0;
                    return {
                        ...food,
                        satFat: Number(estimatedSatFat) || 0
                    };
                }
                return food;
            });
            
            // Ensure all goals have satFat and correct defaults
            if (goals.unsatFat !== undefined && goals.satFat === undefined) {
                goals.satFat = 20;
                delete goals.unsatFat;
                migrated = true;
            }
            if (!goals.satFat) {
                goals.satFat = 20;
                migrated = true;
            }
            if (!goals.salt || goals.salt < 100) { // Old data had salt in grams (6), new is mg (6000)
                goals.salt = 6000;
                migrated = true;
            }
            
            // Ensure all other goals exist
            if (!goals.calories) { goals.calories = 2000; migrated = true; }
            if (!goals.protein) { goals.protein = 150; migrated = true; }
            if (!goals.carbs) { goals.carbs = 200; migrated = true; }
            if (!goals.fat) { goals.fat = 65; migrated = true; }
            if (!goals.sugar) { goals.sugar = 50; migrated = true; }
            if (!goals.fiber) { goals.fiber = 30; migrated = true; }
            
            // Save migrated data
            if (migrated) {
                console.log('üîÑ Migrated old data to new format');
                saveFoodLog();
                saveGoalsData();
            }
        }
        
        function saveFoodLog() {
            localStorage.setItem('nutrition_tracker_log', JSON.stringify(foodLog));
        }
        
        function saveGoalsData() {
            localStorage.setItem('nutrition_tracker_goals', JSON.stringify(goals));
        }
        
        function saveSavedMeals() {
            localStorage.setItem('nutrition_tracker_saved_meals', JSON.stringify(savedMeals));
        }
        
        // Display current date
        const dateDisplay = document.getElementById('dateDisplay');
        const today = new Date();
        dateDisplay.textContent = today.toLocaleDateString('en-GB', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }
        
        function roundToNearest5Minutes(timeStr) {
            if (!timeStr) {
                const now = new Date();
                const minutes = Math.round(now.getMinutes() / 5) * 5;
                now.setMinutes(minutes);
                now.setSeconds(0);
                return now.toTimeString().slice(0, 5);
            }
            const [hours, mins] = timeStr.split(':').map(Number);
            const roundedMins = Math.round(mins / 5) * 5;
            return `${String(hours).padStart(2, '0')}:${String(roundedMins).padStart(2, '0')}`;
        }
        
        function formatTimeForDisplay(timeStr) {
            if (!timeStr) return '';
            const [hours, mins] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${mins} ${ampm}`;
        }
        
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            if (targetDate.getTime() === today.getTime()) {
                return 'Today';
            } else if (targetDate.getTime() === yesterday.getTime()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric',
                    month: 'long'
                });
            }
        }
        
        function changeView(view) {
            currentView = view;
            currentViewDate = null; // Reset single day view
            document.querySelectorAll('.view-btn:not(.settings-btn)').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show date picker only in today view
            if (view === 'today') {
                document.getElementById('datePicker').style.display = 'flex';
                document.getElementById('viewDate').value = getDateString(new Date());
            } else {
                document.getElementById('datePicker').style.display = 'none';
            }
            
            updateDateRange();
            updateDisplay();
        }
        
        function viewSelectedDate() {
            const selectedDate = document.getElementById('viewDate').value;
            if (!selectedDate) {
                alert('Please select a date');
                return;
            }
            currentViewDate = selectedDate;
            currentView = 'today'; // Ensure we're in today view mode
            updateDateRange();
            updateDisplay();
        }
        
        function viewToday() {
            const todayStr = getDateString(new Date());
            document.getElementById('viewDate').value = todayStr;
            currentViewDate = todayStr;
            currentView = 'today';
            updateDateRange();
            updateDisplay();
        }
        
        function toggleSummaryView(view) {
            summaryView = view;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateSummary();
        }
        
        function updateDateRange() {
            const dateRange = document.getElementById('dateRange');
            const logTitle = document.getElementById('logTitle');
            
            if (currentView === 'today') {
                dateRange.textContent = '';
                logTitle.textContent = "Today's Food Log";
            } else if (currentView === 'week') {
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(today);
                
                dateRange.textContent = `${weekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                logTitle.textContent = "This Week's Food Log";
            } else {
                dateRange.textContent = 'All recorded days';
                logTitle.textContent = "All Food Logs";
            }
        }
        
        function getFilteredDates() {
            const today = new Date();
            const todayStr = getDateString(today);
            
            if (currentView === 'today') {
                // If viewing a specific date, return that date
                if (currentViewDate) {
                    return [currentViewDate];
                }
                return [todayStr];
            } else if (currentView === 'week') {
                const dates = [];
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                
                for (let i = 0; i <= today.getDay(); i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    dates.push(getDateString(date));
                }
                return dates;
            } else {
                const uniqueDates = [...new Set(foodLog.map(food => food.date))];
                return uniqueDates.sort().reverse();
            }
        }
        
        function selectMeal(meal) {
            currentMeal = meal;
            document.querySelectorAll('.meal-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show repeat breakfast button only when breakfast is selected
            const repeatBtn = document.getElementById('repeatBreakfastBtn');
            if (meal === 'breakfast') {
                repeatBtn.style.display = 'inline-block';
            } else {
                repeatBtn.style.display = 'none';
            }
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'search') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('searchTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('manualTab').classList.add('active');
            }
        }
        
        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                searchFoods();
            }
        }
        
        async function searchFoods() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            const searchButton = document.getElementById('searchButton');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="info-message">Please enter a food name to search</div>';
                return;
            }
            
            searchButton.disabled = true;
            resultsDiv.innerHTML = '<div class="loading">üîç Searching your foods and database</div>';
            
            try {
                let combinedResults = [];
                
                // STEP 1: Search personal food log first
                const personalFoods = foodLog.filter(food => 
                    food.name.toLowerCase().includes(query.toLowerCase())
                );
                
                // Get unique foods by name (remove duplicates)
                const uniquePersonalFoods = [];
                const seenNames = new Set();
                
                for (const food of personalFoods) {
                    if (!seenNames.has(food.name.toLowerCase())) {
                        seenNames.add(food.name.toLowerCase());
                        uniquePersonalFoods.push(food);
                    }
                }
                
                // Add personal foods to results with a special flag
                if (uniquePersonalFoods.length > 0) {
                    combinedResults = uniquePersonalFoods.slice(0, 5).map(food => ({
                        isPersonal: true,
                        food: food,
                        product_name: food.name,
                        brands: 'Your Foods',
                        image_url: null
                    }));
                }
                
                // STEP 2: Search Open Food Facts
                const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=15&fields=product_name,brands,image_url,nutriments,serving_size,code`);
                
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    const validProducts = data.products.filter(p => 
                        p.nutriments && (p.nutriments.energy_100g || p.nutriments['energy-kcal_100g'])
                    );
                    
                    // Add API products
                    combinedResults = [...combinedResults, ...validProducts.slice(0, 10)];
                }
                
                if (combinedResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="info-message">No foods found. Try a different search term.</div>';
                    return;
                }
                
                resultsDiv.innerHTML = combinedResults.map(item => {
                    if (item.isPersonal) {
                        const food = item.food;
                        // Create a safe object with only the needed properties
                        const safeFood = {
                            name: String(food.name),
                            servingSize: Number(food.servingSize) || 1,
                            servingUnit: String(food.servingUnit || 'serving'),
                            calories: Number(food.calories) || 0,
                            protein: Number(food.protein) || 0,
                            carbs: Number(food.carbs) || 0,
                            fat: Number(food.fat) || 0,
                            sugar: Number(food.sugar) || 0,
                            fiber: Number(food.fiber) || 0,
                            satFat: Number(food.satFat) || 0,
                            salt: Number(food.salt) || 0
                        };
                        
                        return `
                            <div class="search-result-item" style="background: #e8f5e9;" onclick='addPersonalFood(${JSON.stringify(safeFood)})'>
                                <div class="result-image" style="background: #4caf50; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">MY</div>
                                <div class="result-info">
                                    <div class="result-name">${safeFood.name}</div>
                                    <div class="result-brand">Your Foods (Previously Added)</div>
                                    <div class="result-nutrition">
                                        <span>üìä ${Math.round(Number(safeFood.calories) || 0)} kcal</span>
                                        <span>ü•© ${(Number(safeFood.protein) || 0).toFixed(1)}g</span>
                                        <span>üåæ ${(Number(safeFood.carbs) || 0).toFixed(1)}g</span>
                                        <span>ü•ë ${(Number(safeFood.fat) || 0).toFixed(1)}g</span>
                                        <span>(per ${safeFood.servingSize}√ó ${safeFood.servingUnit})</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const nutrients = item.nutriments;
                        const calories = nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184);
                        const protein = nutrients.proteins_100g || 0;
                        const carbs = nutrients.carbohydrates_100g || 0;
                        const fat = nutrients.fat_100g || 0;
                        
                        // Create clean product data
                        const productData = {
                            name: item.product_name || 'Unknown Product',
                            brand: item.brands || '',
                            image: item.image_url || '',
                            code: item.code,
                            nutrients: nutrients
                        };
                        
                        return `
                            <div class="search-result-item" onclick='showServingModal(${JSON.stringify(productData).replace(/'/g, "&#39;")})'>
                                ${item.image_url ? `<img src="${item.image_url}" alt="${item.product_name}" class="result-image">` : '<div class="result-image"></div>'}
                                <div class="result-info">
                                    <div class="result-name">${item.product_name || 'Unknown Product'}</div>
                                    ${item.brands ? `<div class="result-brand">${item.brands}</div>` : ''}
                                    <div class="result-nutrition">
                                        <span>üìä ${Math.round(Number(calories) || 0)} kcal</span>
                                        <span>ü•© ${(Number(protein) || 0).toFixed(1)}g</span>
                                        <span>üåæ ${(Number(carbs) || 0).toFixed(1)}g</span>
                                        <span>ü•ë ${(Number(fat) || 0).toFixed(1)}g</span>
                                        <span>(per 100g)</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}. Please try again.</div>`;
            } finally {
                searchButton.disabled = false;
            }
        }
        
        function addPersonalFood(foodData) {
            try {
                console.log('Adding personal food:', foodData);
                
                // Show serving modal to allow quantity adjustment
                pendingPersonalFood = {
                    name: String(foodData.name),
                    servingSize: Number(foodData.servingSize) || 1,
                    servingUnit: String(foodData.servingUnit || 'serving'),
                    calories: Number(foodData.calories) || 0,
                    protein: Number(foodData.protein) || 0,
                    carbs: Number(foodData.carbs) || 0,
                    fat: Number(foodData.fat) || 0,
                    sugar: Number(foodData.sugar) || 0,
                    fiber: Number(foodData.fiber) || 0,
                    satFat: Number(foodData.satFat) || 0,
                    salt: Number(foodData.salt) || 0
                };
                
                pendingFood = null; // Clear API food
                document.getElementById('servingAmount').value = '1';
                document.getElementById('servingTime').value = roundToNearest5Minutes();
                document.getElementById('saveServingAsMeal').checked = false;
                updatePersonalFoodPreview();
                document.getElementById('servingModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error in addPersonalFood:', error);
                alert(`Error adding food: ${error.message}`);
            }
        }
        
        function updatePersonalFoodPreview() {
            if (!pendingPersonalFood) return;
            
            try {
                const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
                const food = pendingPersonalFood;
                
                document.getElementById('servingPreview').innerHTML = `
                    <strong>${food.name}</strong><br>
                    <span style="color: #667eea; font-weight: 600;">${amount} √ó ${food.servingUnit}</span><br>
                    <div style="margin-top: 6px; color: #666;">
                        ${Math.round(food.calories * amount)} kcal | 
                        P: ${(food.protein * amount).toFixed(1)}g | 
                        C: ${(food.carbs * amount).toFixed(1)}g | 
                        F: ${(food.fat * amount).toFixed(1)}g
                    </div>
                `;
            } catch (error) {
                console.error('Error in updatePersonalFoodPreview:', error);
                document.getElementById('servingPreview').innerHTML = `<div style="color: #c62828;">Unable to preview</div>`;
            }
        }
        
        function showServingModal(productData) {
            console.log('=== showServingModal called ===');
            console.log('Product data:', productData);
            
            try {
                // Validate that we have usable nutrient data
                if (!productData || !productData.nutrients) {
                    console.error('Missing product or nutrients:', productData);
                    alert('This product has incomplete nutritional data. Please try another item or use manual entry.');
                    return;
                }
                
                const nutrients = productData.nutrients;
                console.log('Nutrients object:', nutrients);
                console.log('Nutrient types:', Object.keys(nutrients).map(k => `${k}: ${typeof nutrients[k]}`));
                
                // Check if we have at least calories
                const hasCalories = nutrients['energy-kcal_100g'] || nutrients.energy_100g;
                if (!hasCalories) {
                    console.error('No calorie data:', nutrients);
                    alert('This product is missing calorie information. Please try another item or use manual entry.');
                    return;
                }
                
                // Sanitize the nutrients object - ensure all values are numbers or undefined
                const sanitizedNutrients = {
                    'energy-kcal_100g': parseFloat(nutrients['energy-kcal_100g']) || undefined,
                    'energy_100g': parseFloat(nutrients.energy_100g) || undefined,
                    'proteins_100g': parseFloat(nutrients.proteins_100g) || 0,
                    'carbohydrates_100g': parseFloat(nutrients.carbohydrates_100g) || 0,
                    'fat_100g': parseFloat(nutrients.fat_100g) || 0,
                    'sugars_100g': parseFloat(nutrients.sugars_100g) || 0,
                    'fiber_100g': parseFloat(nutrients.fiber_100g) || 0,
                    'saturated-fat_100g': parseFloat(nutrients['saturated-fat_100g']) || 0,
                    'salt_100g': parseFloat(nutrients.salt_100g) || 0
                };
                
                console.log('Sanitized nutrients:', sanitizedNutrients);
                
                // Update productData with sanitized nutrients
                productData.nutrients = sanitizedNutrients;
                
                pendingFood = productData;
                console.log('Pending food set:', pendingFood);
                
                document.getElementById('servingAmount').value = '1';
                document.getElementById('servingTime').value = roundToNearest5Minutes();
                document.getElementById('saveServingAsMeal').checked = false;
                
                console.log('About to call updateServingPreview');
                updateServingPreview();
                
                console.log('Opening modal');
                document.getElementById('servingModal').style.display = 'block';
                console.log('=== showServingModal completed successfully ===');
            } catch (error) {
                console.error('!!! ERROR in showServingModal !!!');
                console.error('Error object:', error);
                console.error('Error stack:', error.stack);
                console.error('Product data at error:', productData);
                alert(`Unable to load this product: ${error.message}\n\nCheck browser console (F12) for details. Please try another item or use manual entry.`);
            }
        }
        
        function closeServingModal() {
            document.getElementById('servingModal').style.display = 'none';
            pendingFood = null;
        }
        
        function updateServingPreview() {
            const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
            if (!pendingFood || !pendingFood.nutrients) return;
            
            try {
                const nutrients = pendingFood.nutrients;
                const calories = (nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184)) * amount;
                const protein = (nutrients.proteins_100g || 0) * amount;
                const carbs = (nutrients.carbohydrates_100g || 0) * amount;
                const fat = (nutrients.fat_100g || 0) * amount;
                
                document.getElementById('servingPreview').innerHTML = `
                    <strong>${pendingFood.name || 'Unknown'}</strong><br>
                    <span style="color: #667eea; font-weight: 600;">${amount} √ó 100g serving</span><br>
                    <div style="margin-top: 6px; color: #666;">
                        ${Math.round(calories)} kcal | 
                        P: ${protein.toFixed(1)}g | 
                        C: ${carbs.toFixed(1)}g | 
                        F: ${fat.toFixed(1)}g
                    </div>
                `;
            } catch (error) {
                console.error('Error in updateServingPreview:', error);
                document.getElementById('servingPreview').innerHTML = `
                    <div style="color: #c62828;">Unable to preview nutritional data</div>
                `;
            }
        }
        
        document.getElementById('servingAmount').addEventListener('input', function() {
            if (pendingPersonalFood) {
                updatePersonalFoodPreview();
            } else {
                updateServingPreview();
            }
        });
        
        function confirmServing() {
            // Handle personal foods
            if (pendingPersonalFood) {
                try {
                    const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
                    const baseFood = pendingPersonalFood;
                    
                    const food = {
                        id: Date.now(),
                        date: getDateString(new Date()),
                        meal: currentMeal,
                        time: roundToNearest5Minutes(document.getElementById('servingTime').value),
                        name: baseFood.name,
                        servingSize: amount * baseFood.servingSize,
                        servingUnit: baseFood.servingUnit,
                        calories: Number(baseFood.calories * amount),
                        protein: Number(baseFood.protein * amount),
                        carbs: Number(baseFood.carbs * amount),
                        fat: Number(baseFood.fat * amount),
                        sugar: Number(baseFood.sugar * amount),
                        fiber: Number(baseFood.fiber * amount),
                        satFat: Number(baseFood.satFat * amount),
                        salt: Number(baseFood.salt * amount)
                    };
                    
                    foodLog.push(food);
                    saveFoodLog();
                    updateDisplay();
                    
                    closeServingModal();
                    pendingPersonalFood = null;
                    
                    const resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = `<div class="success-message">‚úÖ Added "${baseFood.name}" to ${currentMeal}!</div>`;
                    document.getElementById('searchInput').value = '';
                    setTimeout(() => { resultsDiv.innerHTML = ''; }, 3000);
                    return;
                } catch (error) {
                    console.error('Error adding personal food:', error);
                    alert(`Error: ${error.message}`);
                    closeServingModal();
                    return;
                }
            }
            
            // Handle API foods
            if (!pendingFood) return;
            
            try {
                const amount = parseFloat(document.getElementById('servingAmount').value) || 1;
                const nutrients = pendingFood.nutrients;
                
                const calories = (nutrients['energy-kcal_100g'] || Math.round((nutrients.energy_100g || 0) / 4.184)) * amount;
                const protein = (nutrients.proteins_100g || 0) * amount;
                const carbs = (nutrients.carbohydrates_100g || 0) * amount;
                const fat = (nutrients.fat_100g || 0) * amount;
                const sugar = (nutrients.sugars_100g || 0) * amount;
                const fiber = (nutrients.fiber_100g || 0) * amount;
                const saturatedFat = (nutrients['saturated-fat_100g'] || 0) * amount;
                const salt = ((nutrients.salt_100g || 0) * 1000) * amount; // Convert g to mg
                const satFat = Math.max(0, fat - saturatedFat);
                
                const foodName = `${pendingFood.name}${pendingFood.brand ? ' - ' + pendingFood.brand : ''}`;
                
                const food = {
                    id: Date.now(),
                    date: getDateString(new Date()),
                    meal: currentMeal,
                    time: roundToNearest5Minutes(document.getElementById('servingTime').value),
                    name: foodName,
                    servingSize: Number(amount),
                    servingUnit: '100g',
                    calories: Number(calories),
                    protein: Number(protein),
                    carbs: Number(carbs),
                    fat: Number(fat),
                    sugar: Number(sugar),
                    fiber: Number(fiber),
                    satFat: Number(satFat),
                    salt: Number(salt)
                };
                
                // Validate all numbers
                const numFields = ['calories', 'protein', 'carbs', 'fat', 'sugar', 'fiber', 'satFat', 'salt'];
                for (let field of numFields) {
                    if (typeof food[field] !== 'number' || isNaN(food[field])) {
                        console.error(`Invalid ${field}:`, food[field]);
                        food[field] = 0;
                    }
                }
                
                foodLog.push(food);
                
                // Save as meal if checked
                if (document.getElementById('saveServingAsMeal').checked) {
                    const mealName = prompt('Enter a name for this meal:');
                    if (mealName) {
                        savedMeals.push({
                            id: Date.now(),
                            name: mealName,
                            foods: [food]
                        });
                        saveSavedMeals();
                    }
                }
                
                saveFoodLog();
                updateDisplay();
                
                closeServingModal();
                
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = `<div class="success-message">‚úÖ Added to ${currentMeal}!</div>`;
                document.getElementById('searchInput').value = '';
                
                setTimeout(() => {
                    resultsDiv.innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Error in confirmServing:', error);
                alert(`Error adding food: ${error.message}. Please try again or use manual entry.`);
                closeServingModal();
            }
        }
        
        document.getElementById('foodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const servingSize = parseFloat(document.getElementById('servingSize').value) || 1;
            
            const food = {
                id: Date.now(),
                date: getDateString(new Date()),
                meal: document.getElementById('mealType').value,
                time: roundToNearest5Minutes(document.getElementById('foodTime').value),
                name: document.getElementById('foodName').value,
                servingSize: servingSize,
                servingUnit: 'serving',
                calories: Number(parseFloat(document.getElementById('calories').value)) || 0,
                protein: Number(parseFloat(document.getElementById('protein').value)) || 0,
                carbs: Number(parseFloat(document.getElementById('carbs').value)) || 0,
                fat: Number(parseFloat(document.getElementById('fat').value)) || 0,
                sugar: Number(parseFloat(document.getElementById('sugar').value)) || 0,
                fiber: Number(parseFloat(document.getElementById('fiber').value)) || 0,
                satFat: Number(parseFloat(document.getElementById('satFat').value)) || 0,
                salt: Number(parseFloat(document.getElementById('salt').value)) || 0
            };
            
            foodLog.push(food);
            
            // Save as meal if checked
            if (document.getElementById('saveAsMeal').checked) {
                const mealName = prompt('Enter a name for this meal:');
                if (mealName) {
                    savedMeals.push({
                        id: Date.now(),
                        name: mealName,
                        foods: [food]
                    });
                    saveSavedMeals();
                }
            }
            
            saveFoodLog();
            updateDisplay();
            this.reset();
            document.getElementById('servingSize').value = '1';
        });
        
        function updateSummary() {
            const dates = getFilteredDates();
            const filteredLog = foodLog.filter(food => dates.includes(food.date));
            
            const totals = filteredLog.reduce((acc, food) => {
                acc.calories += Number(food.calories) || 0;
                acc.protein += Number(food.protein) || 0;
                acc.carbs += Number(food.carbs) || 0;
                acc.fat += Number(food.fat) || 0;
                acc.sugar += Number(food.sugar) || 0;
                acc.fiber += Number(food.fiber) || 0;
                acc.satFat += Number(food.satFat) || 0;
                acc.salt += Number(food.salt) || 0;
                return acc;
            }, {
                calories: 0, protein: 0, carbs: 0, fat: 0,
                sugar: 0, fiber: 0, satFat: 0, salt: 0
            });
            
            const summaryGrid = document.getElementById('summaryGrid');
            const nutrients = ['calories', 'protein', 'carbs', 'fat', 'sugar', 'fiber', 'satFat', 'salt'];
            const labels = {
                calories: 'Calories',
                protein: 'Protein',
                carbs: 'Carbs',
                fat: 'Fat',
                sugar: 'Sugar',
                fiber: 'Fiber',
                satFat: 'Sat Fat',
                salt: 'Salt'
            };
            const units = {
                calories: 'kcal',
                protein: 'g',
                carbs: 'g',
                fat: 'g',
                sugar: 'g',
                fiber: 'g',
                satFat: 'g',
                salt: 'mg'
            };
            
            summaryGrid.innerHTML = nutrients.map(nutrient => {
                const value = totals[nutrient];
                const goal = goals[nutrient];
                const percent = goal > 0 ? (value / goal * 100) : 0;
                const displayValue = summaryView === 'totals' 
                    ? `${nutrient === 'calories' ? Math.round(value) : value.toFixed(1)}`
                    : `${Math.round(percent)}%`;
                
                return `
                    <div class="summary-item">
                        <div class="summary-label">${labels[nutrient]}</div>
                        <div class="summary-value">${displayValue}</div>
                        <div class="summary-goal">${summaryView === 'totals' ? `/ ${goal} ${units[nutrient]}` : `of ${goal} ${units[nutrient]}`}</div>
                        <div class="summary-bar">
                            <div class="summary-bar-fill ${percent > 100 ? 'over-goal' : ''}" style="width: ${Math.min(percent, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Show recent items if in today view
            const recentItemsContainer = document.getElementById('recentItemsContainer');
            if (currentView === 'today' && filteredLog.length > 0) {
                // Sort by ID (entry order) - most recent entries first
                const sortedItems = [...filteredLog].sort((a, b) => b.id - a.id);
                
                const mealEmojis = {
                    breakfast: 'üç≥',
                    lunch: 'ü•ó',
                    dinner: 'üçΩÔ∏è',
                    snacks: 'üçø'
                };
                
                recentItemsContainer.innerHTML = `
                    <div class="recent-items-section">
                        <div class="recent-items-header">Today's Items (${filteredLog.length} total)</div>
                        ${sortedItems.map(food => `
                            <div class="recent-item">
                                <div class="recent-item-info">
                                    <div class="recent-item-name">${mealEmojis[food.meal]} ${food.name}</div>
                                    <div class="recent-item-details">
                                        ${food.servingSize}√ó ${food.servingUnit} ‚Ä¢ ${Math.round(food.calories)} kcal
                                        ${food.time ? ` ‚Ä¢ ${formatTimeForDisplay(food.time)}` : ''}
                                    </div>
                                </div>
                                <div class="recent-item-actions">
                                    <button class="edit-btn" onclick="editFood(${food.id})">Edit</button>
                                    <button class="delete-btn" onclick="deleteFood(${food.id})">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                recentItemsContainer.innerHTML = '';
            }
        }
        
        function updateDisplay() {
            try {
                updateSummary();
                
                const dates = getFilteredDates();
                const filteredLog = foodLog.filter(food => dates.includes(food.date));
                
                const foodList = document.getElementById('foodList');
                if (filteredLog.length === 0) {
                    foodList.innerHTML = '<div class="empty-state">No foods logged for this period.</div>';
                    return;
                }
                
                const foodsByDate = {};
                dates.forEach(date => {
                    foodsByDate[date] = foodLog.filter(food => food.date === date);
                });
                
                foodList.innerHTML = dates.map(date => {
                    const dayFoods = foodsByDate[date];
                    if (dayFoods.length === 0) return '';
                    
                    const dayTotals = dayFoods.reduce((acc, food) => {
                        acc.calories += Number(food.calories) || 0;
                        return acc;
                    }, { calories: 0 });
                    
                    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snacks'];
                    const mealLabels = {
                        breakfast: 'üç≥ Breakfast',
                        lunch: 'ü•ó Lunch',
                        dinner: 'üçΩÔ∏è Dinner',
                        snacks: 'üçø Snacks'
                    };
                    
                    return `
                        <div class="day-section">
                            <div class="day-header">
                                <span>${formatDateForDisplay(date)}</span>
                                <span class="day-totals">${Math.round(dayTotals.calories)} kcal</span>
                            </div>
                            ${mealTypes.map(mealType => {
                                const mealFoods = dayFoods.filter(f => f.meal === mealType);
                                if (mealFoods.length === 0) return '';
                                
                                // Sort by time within each meal
                                mealFoods.sort((a, b) => {
                                    if (!a.time && !b.time) return 0;
                                    if (!a.time) return 1;
                                    if (!b.time) return -1;
                                    return a.time.localeCompare(b.time);
                                });
                                
                                const mealTotals = mealFoods.reduce((acc, food) => {
                                    acc.calories += Number(food.calories) || 0;
                                    return acc;
                                }, { calories: 0 });
                                
                                return `
                                    <div class="meal-section">
                                        <div class="meal-header">
                                            <span>${mealLabels[mealType]}</span>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span class="meal-totals">${Math.round(mealTotals.calories)} kcal</span>
                                                ${mealFoods.length > 0 ? `<button class="quick-action-btn" style="padding: 4px 10px; font-size: 0.75em; width: auto; margin: 0;" onclick="saveMealFromLog('${date}', '${mealType}')">üíæ Save as Meal</button>` : ''}
                                            </div>
                                        </div>
                                        ${mealFoods.map(food => {
                                            try {
                                                return `
                                                    <div class="food-item">
                                                        <div class="food-details">
                                                            <div class="food-name">${food.name || 'Unknown'}</div>
                                                            <div class="food-serving">${Number(food.servingSize) || 1}√ó ${food.servingUnit || 'serving'}</div>
                                                            ${food.time ? `<div class="food-time">üïê ${formatTimeForDisplay(food.time)}</div>` : ''}
                                                            <div class="food-macros">
                                                                <span class="macro-item">üìä ${Math.round(Number(food.calories) || 0)} kcal</span>
                                                                <span class="macro-item">ü•© P: ${(Number(food.protein) || 0).toFixed(1)}g</span>
                                                                <span class="macro-item">üåæ C: ${(Number(food.carbs) || 0).toFixed(1)}g</span>
                                                                <span class="macro-item">ü•ë F: ${(Number(food.fat) || 0).toFixed(1)}g</span>
                                                                ${(Number(food.sugar) || 0) > 0 ? `<span class="macro-item">üç¨ ${(Number(food.sugar) || 0).toFixed(1)}g</span>` : ''}
                                                                ${(Number(food.fiber) || 0) > 0 ? `<span class="macro-item">üåø ${(Number(food.fiber) || 0).toFixed(1)}g</span>` : ''}
                                                                ${(Number(food.salt) || 0) > 0 ? `<span class="macro-item">üßÇ ${Math.round(Number(food.salt) || 0)}mg</span>` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="food-item-actions">
                                                            <button class="edit-btn" onclick="editFood(${food.id})">Edit</button>
                                                            <button class="delete-btn" onclick="deleteFood(${food.id})">Delete</button>
                                                        </div>
                                                    </div>
                                                `;
                                            } catch (err) {
                                                console.error('Error displaying food item:', food, err);
                                                return '';
                                            }
                                        }).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in updateDisplay:', error);
                document.getElementById('foodList').innerHTML = `<div class="error-message">Error displaying food log. Please refresh the page.</div>`;
            }
        }
        
        function deleteFood(id) {
            if (!confirm('Delete this food entry?')) return;
            foodLog = foodLog.filter(food => food.id !== id);
            saveFoodLog();
            updateDisplay();
        }
        
        function editFood(id) {
            const food = foodLog.find(f => f.id === id);
            if (!food) return;
            
            editingFoodId = id;
            document.getElementById('editServingSize').value = food.servingSize;
            document.getElementById('editTime').value = food.time || roundToNearest5Minutes();
            
            updateEditPreview(food);
            document.getElementById('editFoodModal').style.display = 'block';
        }
        
        function updateEditPreview(food) {
            const newServing = parseFloat(document.getElementById('editServingSize').value) || food.servingSize;
            const multiplier = newServing / food.servingSize;
            
            document.getElementById('editPreview').innerHTML = `
                <strong>${food.name}</strong><br>
                <span style="color: #667eea; font-weight: 600;">${newServing}√ó ${food.servingUnit}</span><br>
                <div style="margin-top: 6px; color: #666;">
                    ${Math.round(food.calories * multiplier)} kcal | 
                    P: ${(food.protein * multiplier).toFixed(1)}g | 
                    C: ${(food.carbs * multiplier).toFixed(1)}g | 
                    F: ${(food.fat * multiplier).toFixed(1)}g
                </div>
            `;
        }
        
        document.getElementById('editServingSize').addEventListener('input', function() {
            const food = foodLog.find(f => f.id === editingFoodId);
            if (food) updateEditPreview(food);
        });
        
        function closeEditModal() {
            document.getElementById('editFoodModal').style.display = 'none';
            editingFoodId = null;
        }
        
        function saveEdit() {
            const food = foodLog.find(f => f.id === editingFoodId);
            if (!food) return;
            
            const originalServing = food.servingSize;
            const newServing = parseFloat(document.getElementById('editServingSize').value);
            const newTime = roundToNearest5Minutes(document.getElementById('editTime').value);
            
            if (newServing <= 0 || !newServing) {
                alert('Please enter a valid serving size');
                return;
            }
            
            // Calculate multiplier and update all nutrients
            const multiplier = newServing / originalServing;
            
            food.servingSize = newServing;
            food.time = newTime;
            food.calories *= multiplier;
            food.protein *= multiplier;
            food.carbs *= multiplier;
            food.fat *= multiplier;
            food.sugar *= multiplier;
            food.fiber *= multiplier;
            food.satFat *= multiplier;
            food.salt *= multiplier;
            
            saveFoodLog();
            updateDisplay();
            closeEditModal();
        }
        
        function openSettingsModal() {
            // Ensure all goals exist with defaults
            if (!goals.calories) goals.calories = 2000;
            if (!goals.protein) goals.protein = 150;
            if (!goals.carbs) goals.carbs = 200;
            if (!goals.fat) goals.fat = 65;
            if (!goals.sugar) goals.sugar = 50;
            if (!goals.fiber) goals.fiber = 30;
            if (!goals.satFat) goals.satFat = 20;
            if (!goals.salt) goals.salt = 6000;
            
            document.getElementById('goalCalories').value = goals.calories;
            document.getElementById('goalProtein').value = goals.protein;
            document.getElementById('goalCarbs').value = goals.carbs;
            document.getElementById('goalFat').value = goals.fat;
            document.getElementById('goalSugar').value = goals.sugar;
            document.getElementById('goalFiber').value = goals.fiber;
            document.getElementById('goalSatFat').value = goals.satFat;
            document.getElementById('goalSalt').value = goals.salt;
            
            // Set date defaults to today
            const todayStr = getDateString(new Date());
            document.getElementById('exportStartDate').value = todayStr;
            document.getElementById('exportEndDate').value = todayStr;
            
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function exportToExcel() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Filter food log by date range
            const filteredData = foodLog.filter(food => {
                return food.date >= startDate && food.date <= endDate;
            }).sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                if (!a.time || !b.time) return 0;
                return a.time.localeCompare(b.time);
            });
            
            if (filteredData.length === 0) {
                alert('No data found for the selected date range');
                return;
            }
            
            // Prepare data for Excel
            const excelData = filteredData.map(food => ({
                'Date': food.date,
                'Time': food.time ? formatTimeForDisplay(food.time) : '',
                'Meal': food.meal.charAt(0).toUpperCase() + food.meal.slice(1),
                'Food Name': food.name,
                'Serving': `${food.servingSize} ${food.servingUnit}`,
                'Calories (kcal)': Math.round(Number(food.calories) || 0),
                'Protein (g)': (Number(food.protein) || 0).toFixed(1),
                'Carbs (g)': (Number(food.carbs) || 0).toFixed(1),
                'Fat (g)': (Number(food.fat) || 0).toFixed(1),
                'Sugar (g)': (Number(food.sugar) || 0).toFixed(1),
                'Fiber (g)': (Number(food.fiber) || 0).toFixed(1),
                'Saturated Fat (g)': (Number(food.satFat) || 0).toFixed(1),
                'Salt (mg)': Math.round(Number(food.salt) || 0)
            }));
            
            // Calculate daily totals
            const dailyTotals = {};
            filteredData.forEach(food => {
                if (!dailyTotals[food.date]) {
                    dailyTotals[food.date] = {
                        calories: 0, protein: 0, carbs: 0, fat: 0,
                        sugar: 0, fiber: 0, satFat: 0, salt: 0
                    };
                }
                dailyTotals[food.date].calories += Number(food.calories) || 0;
                dailyTotals[food.date].protein += Number(food.protein) || 0;
                dailyTotals[food.date].carbs += Number(food.carbs) || 0;
                dailyTotals[food.date].fat += Number(food.fat) || 0;
                dailyTotals[food.date].sugar += Number(food.sugar) || 0;
                dailyTotals[food.date].fiber += Number(food.fiber) || 0;
                dailyTotals[food.date].satFat += Number(food.satFat) || 0;
                dailyTotals[food.date].salt += Number(food.salt) || 0;
            });
            
            const summaryData = Object.keys(dailyTotals).map(date => ({
                'Date': date,
                'Calories (kcal)': Math.round(dailyTotals[date].calories),
                'Protein (g)': dailyTotals[date].protein.toFixed(1),
                'Carbs (g)': dailyTotals[date].carbs.toFixed(1),
                'Fat (g)': dailyTotals[date].fat.toFixed(1),
                'Sugar (g)': dailyTotals[date].sugar.toFixed(1),
                'Fiber (g)': dailyTotals[date].fiber.toFixed(1),
                'Saturated Fat (g)': dailyTotals[date].satFat.toFixed(1),
                'Salt (mg)': Math.round(dailyTotals[date].salt),
                '% of Goal - Calories': ((dailyTotals[date].calories / (goals.calories || 2000)) * 100).toFixed(0) + '%',
                '% of Goal - Protein': ((dailyTotals[date].protein / (goals.protein || 150)) * 100).toFixed(0) + '%',
                '% of Goal - Carbs': ((dailyTotals[date].carbs / (goals.carbs || 200)) * 100).toFixed(0) + '%',
                '% of Goal - Fat': ((dailyTotals[date].fat / (goals.fat || 65)) * 100).toFixed(0) + '%'
            }));
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add detailed log sheet
            const ws1 = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Detailed Log');
            
            // Add daily summary sheet
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Daily Summary');
            
            // Add goals sheet
            const goalsData = [
                { 'Nutrient': 'Calories', 'Daily Goal': goals.calories, 'Unit': 'kcal' },
                { 'Nutrient': 'Protein', 'Daily Goal': goals.protein, 'Unit': 'g' },
                { 'Nutrient': 'Carbs', 'Daily Goal': goals.carbs, 'Unit': 'g' },
                { 'Nutrient': 'Fat', 'Daily Goal': goals.fat, 'Unit': 'g' },
                { 'Nutrient': 'Sugar', 'Daily Goal': goals.sugar, 'Unit': 'g' },
                { 'Nutrient': 'Fiber', 'Daily Goal': goals.fiber, 'Unit': 'g' },
                { 'Nutrient': 'Saturated Fat', 'Daily Goal': goals.satFat, 'Unit': 'g' },
                { 'Nutrient': 'Salt', 'Daily Goal': goals.salt, 'Unit': 'mg' }
            ];
            const ws3 = XLSX.utils.json_to_sheet(goalsData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Goals');
            
            // Generate filename
            const filename = `Nutrition_Tracker_${startDate}_to_${endDate}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
            
            alert(`Excel file downloaded: ${filename}`);
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function saveGoals() {
            goals.calories = parseFloat(document.getElementById('goalCalories').value) || 2000;
            goals.protein = parseFloat(document.getElementById('goalProtein').value) || 150;
            goals.carbs = parseFloat(document.getElementById('goalCarbs').value) || 200;
            goals.fat = parseFloat(document.getElementById('goalFat').value) || 65;
            goals.sugar = parseFloat(document.getElementById('goalSugar').value) || 50;
            goals.fiber = parseFloat(document.getElementById('goalFiber').value) || 30;
            goals.satFat = parseFloat(document.getElementById('goalSatFat').value) || 20;
            goals.salt = parseFloat(document.getElementById('goalSalt').value) || 6000;
            
            saveGoalsData();
            syncToCloud(); // Auto-sync after saving
            closeSettingsModal();
            updateDisplay();
        }
        
        // Cloud Sync Variables
        let cloudSyncEnabled = false;
        let syncUserId = null;
        let syncInterval = null;
        const SYNC_API_URL = 
'https://script.google.com/macros/s/AKfycbztBRjZqaxnXXEipfs0zXP5xu3GZYoW7c_Hw5pe7JFhSfVfc4Wjwik3HEkY4UJIEn8/exec'; // Replace with your Google Apps Script URL
        const SYNC_INTERVAL_MS = 30000; // Sync every 30 seconds
        
        function checkCloudSync() {
            cloudSyncEnabled = localStorage.getItem('cloud_sync_enabled') === 'true';
            syncUserId = localStorage.getItem('sync_user_id');
            updateCloudSyncStatus();
            
            if (cloudSyncEnabled && syncUserId) {
                // Start auto-sync
                startAutoSync();
            }
        }
        
        function startAutoSync() {
            // Clear any existing interval
            if (syncInterval) clearInterval(syncInterval);
            
            // Sync immediately
            syncFromCloud();
            
            // Then sync every 30 seconds
            syncInterval = setInterval(() => {
                syncFromCloud();
            }, SYNC_INTERVAL_MS);
            
            console.log('üîÑ Auto-sync started (every 30 seconds)');
        }
        
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            console.log('‚è∏Ô∏è Auto-sync stopped');
        }
        
        function updateCloudSyncStatus() {
            const statusDiv = document.getElementById('cloudSyncStatus');
            const connectBtn = document.getElementById('cloudSyncBtn');
            const disconnectBtn = document.getElementById('disconnectSyncBtn');
            
            if (cloudSyncEnabled && syncUserId) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.borderColor = '#28a745';
                statusDiv.innerHTML = `
                    <strong>‚úÖ Cloud Sync Active</strong><br><br>
                    Your data automatically syncs across all devices.<br>
                    User ID: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">${syncUserId.substring(0, 8)}...</code><br>
                    <small>Last sync: ${new Date().toLocaleTimeString()}</small>
                `;
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.borderColor = '#ffc107';
                statusDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Cloud Sync Not Connected</strong><br><br>
                    Click "Connect Cloud Sync" below to enable automatic syncing across all your devices.
                `;
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
            }
        }
        
        async function setupCloudSync() {
            // Check if API URL is configured
            if (SYNC_API_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
                alert('‚ùå Cloud Sync Not Configured!\n\nPlease follow the setup instructions:\n\n1. Set up Google Sheets backend\n2. Get your Web App URL\n3. Paste it in the HTML file\n\nSee GOOGLE-SHEETS-SETUP-INSTRUCTIONS.md for details.');
                return;
            }
            
            const confirmMsg = `Enable automatic Google Sheets cloud sync?\n\n` +
                `This will:\n` +
                `‚Ä¢ Create a unique sync ID for you\n` +
                `‚Ä¢ Store your data in YOUR Google Sheets\n` +
                `‚Ä¢ Automatically sync across ALL devices\n` +
                `‚Ä¢ Sync every 30 seconds\n\n` +
                `Your data stays private in your Google account.`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Generate unique user ID
                syncUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                localStorage.setItem('cloud_sync_enabled', 'true');
                localStorage.setItem('sync_user_id', syncUserId);
                cloudSyncEnabled = true;
                
                updateCloudSyncStatus();
                
                // Initial sync to cloud
                await syncToCloud();
                
                // Start automatic syncing
                startAutoSync();
                
                alert('‚úÖ Cloud Sync Connected!\n\nYour data will now automatically sync across all devices every 30 seconds.\n\nUse this same browser on your other devices to access synced data.');
            } catch (error) {
                console.error('Cloud sync setup error:', error);
                alert('Error setting up cloud sync:\n\n' + error.message + '\n\nPlease check your Google Sheets setup.');
            }
        }
        
        function disconnectCloudSync() {
            if (!confirm('Disconnect cloud sync?\n\nYour local data will be kept, but it will no longer sync across devices.')) {
                return;
            }
            
            stopAutoSync();
            localStorage.removeItem('cloud_sync_enabled');
            localStorage.removeItem('sync_user_id');
            cloudSyncEnabled = false;
            syncUserId = null;
            updateCloudSyncStatus();
            
            alert('Cloud sync disconnected.\n\nYour data remains on this device.');
        }
        
        async function syncToCloud() {
            if (!cloudSyncEnabled || !syncUserId || SYNC_API_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') return;
            
            try {
                const syncData = {
                    userId: syncUserId,
                    foodLog: foodLog,
                    goals: goals,
                    savedMeals: savedMeals
                };
                
                const response = await fetch(SYNC_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(syncData)
                });
                
                console.log('‚òÅÔ∏è Synced to cloud:', new Date().toLocaleTimeString());
                updateCloudSyncStatus(); // Update timestamp
            } catch (error) {
                console.error('Sync to cloud error:', error);
            }
        }
        
        async function syncFromCloud() {
            if (!cloudSyncEnabled || !syncUserId || SYNC_API_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') return;
            
            try {
                const response = await fetch(`${SYNC_API_URL}?userId=${syncUserId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const cloudData = result.data;
                    
                    // Merge food log
                    const existingIds = new Set(foodLog.map(f => f.id));
                    let addedCount = 0;
                    
                    cloudData.foodLog.forEach(food => {
                        if (!existingIds.has(food.id)) {
                            foodLog.push(food);
                            addedCount++;
                        }
                    });
                    
                    // Merge saved meals
                    if (cloudData.savedMeals) {
                        const existingMealIds = new Set(savedMeals.map(m => m.id));
                        cloudData.savedMeals.forEach(meal => {
                            if (!existingMealIds.has(meal.id)) {
                                savedMeals.push(meal);
                            }
                        });
                    }
                    
                    // Update goals if newer
                    if (cloudData.goals && Object.keys(cloudData.goals).length > 0) {
                        goals = cloudData.goals;
                        saveGoalsData();
                    }
                    
                    if (addedCount > 0) {
                        saveFoodLog();
                        saveSavedMeals();
                        updateDisplay();
                        console.log(`‚òÅÔ∏è Downloaded ${addedCount} new items from cloud`);
                    }
                }
            } catch (error) {
                console.error('Sync from cloud error:', error);
            }
        }
        
        // Auto-sync after adding food
        const originalSaveFoodLog = saveFoodLog;
        saveFoodLog = function() {
            originalSaveFoodLog();
            syncToCloud();
        };
        
        // Manual sync functions for cross-device
        function exportManualSyncCode() {
            try {
                const syncData = {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    deviceName: navigator.userAgent.includes('Mobile') ? 'Phone' : 'PC',
                    foodLog: foodLog,
                    goals: goals,
                    savedMeals: savedMeals
                };
                
                const syncCode = btoa(JSON.stringify(syncData));
                document.getElementById('manualSyncCodeArea').value = syncCode;
                
                // Try to copy to clipboard
                navigator.clipboard.writeText(syncCode).then(() => {
                    alert(`‚úÖ Sync code copied to clipboard!\n\nExported ${foodLog.length} food entries from your ${syncData.deviceName}.\n\nPaste this on your other device.`);
                }).catch(() => {
                    alert(`‚úÖ Sync code generated!\n\nExported ${foodLog.length} food entries.\n\nManually copy the code and paste on your other device.`);
                });
            } catch (error) {
                console.error('Export sync error:', error);
                alert('Error generating sync code. Please try again.');
            }
        }
        
        function importManualSyncCode() {
            try {
                let syncCode = document.getElementById('manualSyncCodeArea').value.trim();
                
                if (!syncCode) {
                    syncCode = prompt('Paste your sync code here:\n\n(Get this from Settings on your other device)');
                }
                
                if (!syncCode || syncCode.trim() === '') {
                    return;
                }
                
                const syncData = JSON.parse(atob(syncCode.trim()));
                
                if (!syncData.version || !syncData.foodLog) {
                    alert('Invalid sync code. Please check and try again.');
                    return;
                }
                
                // Show confirmation
                const confirmMsg = `Import data from ${syncData.deviceName || 'other device'}?\n\n` +
                    `Exported: ${new Date(syncData.exportDate).toLocaleString()}\n\n` +
                    `Contains:\n` +
                    `‚Ä¢ ${syncData.foodLog.length} food entries\n` +
                    `‚Ä¢ ${syncData.savedMeals?.length || 0} saved meals\n` +
                    `‚Ä¢ Nutrition goals\n\n` +
                    `Your existing data will be MERGED (not replaced).`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // Merge food log (avoid duplicates by ID)
                const existingIds = new Set(foodLog.map(f => f.id));
                let addedCount = 0;
                
                syncData.foodLog.forEach(food => {
                    if (!existingIds.has(food.id)) {
                        foodLog.push(food);
                        addedCount++;
                    }
                });
                
                // Merge saved meals
                if (syncData.savedMeals) {
                    const existingMealIds = new Set(savedMeals.map(m => m.id));
                    let mealsAdded = 0;
                    syncData.savedMeals.forEach(meal => {
                        if (!existingMealIds.has(meal.id)) {
                            savedMeals.push(meal);
                            mealsAdded++;
                        }
                    });
                }
                
                // Import goals (ask user)
                if (syncData.goals && confirm('Also import nutrition goals from other device?')) {
                    goals = syncData.goals;
                    saveGoalsData();
                }
                
                // Save everything
                saveFoodLog();
                saveSavedMeals();
                updateDisplay();
                
                alert(`‚úÖ Sync complete!\n\nAdded ${addedCount} new food entries.\n\nYour devices are now synced!`);
                document.getElementById('manualSyncCodeArea').value = '';
                
            } catch (error) {
                console.error('Import sync error:', error);
                alert('Error importing sync code.\n\nPlease check the code and try again.');
            }
        }
        
        function openSavedMealsModal() {
            const modalBody = document.getElementById('savedMealsList');
            
            if (savedMeals.length === 0) {
                modalBody.innerHTML = '<div class="empty-state">No saved meals yet. Save a meal by clicking "üíæ Save as Meal" button next to any meal in your food log.</div>';
            } else {
                modalBody.innerHTML = savedMeals.map(meal => {
                    const totalCals = meal.foods.reduce((sum, f) => sum + (Number(f.calories) || 0), 0);
                    const mealEmoji = meal.mealType === 'breakfast' ? 'üç≥' : meal.mealType === 'lunch' ? 'ü•ó' : meal.mealType === 'dinner' ? 'üçΩÔ∏è' : 'üçø';
                    
                    return `
                        <div class="saved-meal-item" onclick="addSavedMeal(${meal.id})">
                            <div class="saved-meal-name">${mealEmoji} ${meal.name}</div>
                            <div class="saved-meal-info">${meal.itemCount || meal.foods.length} item(s) ‚Ä¢ ${Math.round(totalCals)} kcal</div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('savedMealsModal').style.display = 'block';
        }
        
        function closeSavedMealsModal() {
            document.getElementById('savedMealsModal').style.display = 'none';
        }
        
        function addSavedMeal(mealId) {
            const meal = savedMeals.find(m => m.id === mealId);
            if (!meal) return;
            
            const currentTime = roundToNearest5Minutes();
            
            meal.foods.forEach((food, index) => {
                const newFood = {
                    ...food,
                    id: Date.now() + Math.random() + index,
                    date: getDateString(new Date()),
                    meal: currentMeal,
                    time: currentTime
                };
                foodLog.push(newFood);
            });
            
            saveFoodLog();
            updateDisplay();
            closeSavedMealsModal();
            alert(`‚úÖ Added "${meal.name}" (${meal.foods.length} items) to ${currentMeal}!`);
        }
        
        function repeatYesterdayBreakfast() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getDateString(yesterday);
            
            const yesterdayBreakfast = foodLog.filter(f => f.date === yesterdayStr && f.meal === 'breakfast');
            
            if (yesterdayBreakfast.length === 0) {
                alert('No breakfast found for yesterday!');
                return;
            }
            
            yesterdayBreakfast.forEach(food => {
                const newFood = {
                    ...food,
                    id: Date.now() + Math.random(),
                    date: getDateString(new Date())
                };
                foodLog.push(newFood);
            });
            
            saveFoodLog();
            updateDisplay();
            alert(`‚úÖ Added ${yesterdayBreakfast.length} item(s) from yesterday's breakfast!`);
        }
        
        function saveMealFromLog(date, mealType) {
            const mealFoods = foodLog.filter(f => f.date === date && f.meal === mealType);
            
            if (mealFoods.length === 0) {
                alert('No items found in this meal!');
                return;
            }
            
            const mealName = prompt(`Save this ${mealType} (${mealFoods.length} items) as a meal.\n\nEnter a name for this meal:`);
            
            if (!mealName || mealName.trim() === '') {
                return;
            }
            
            // Create a copy of the foods without date/time so they can be added any time
            const mealFoodsCopy = mealFoods.map(food => ({
                name: food.name,
                servingSize: food.servingSize,
                servingUnit: food.servingUnit,
                calories: food.calories,
                protein: food.protein,
                carbs: food.carbs,
                fat: food.fat,
                sugar: food.sugar,
                fiber: food.fiber,
                satFat: food.satFat,
                salt: food.salt
            }));
            
            savedMeals.push({
                id: Date.now(),
                name: mealName.trim(),
                mealType: mealType,
                itemCount: mealFoods.length,
                foods: mealFoodsCopy
            });
            
            saveSavedMeals();
            alert(`‚úÖ Saved "${mealName}" with ${mealFoods.length} items!`);
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
        // Initial load
        loadData();
        updateDateRange();
        updateDisplay();
        
        // Set default time for manual entry
        document.getElementById('foodTime').value = roundToNearest5Minutes();
        
        // Set up date picker
        document.getElementById('viewDate').value = getDateString(new Date());
        document.getElementById('datePicker').style.display = 'flex';
        
        // Show repeat breakfast button since breakfast is default
        document.getElementById('repeatBreakfastBtn').style.display = 'inline-block';
        
        // Check and initialize cloud sync
        checkCloudSync();
    </script>
</body>
</html>
